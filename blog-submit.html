<!DOCTYPE html>

<html>

<head>
    <title>Submit a new post</title>
    <!--<a href="https://icons8.com">Icon pack by Icons8</a>-->
    <script src="https://cdn.quilljs.com/1.1.3/quill.js"></script>
    <script src="https://cdn.quilljs.com/1.1.3/quill.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

    <link href="https://fonts.googleapis.com/css?family=Julius+Sans+One|Patua+One" rel="stylesheet">
    <!--Thanks for the stylin', Quilljs!-->
    <link href="https://cdn.quilljs.com/1.1.3/quill.snow.css" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.1.3/quill.bubble.css" rel="stylesheet">

    <style>
        #editor {
            height: 20rem;
        }

        #comment-box {

            display: flex;
            flex-direction: column;
            height: 5rem;
            width: 80vw;
            font-family: 'Helvetica Neue', 'HelveticaNeue', 'Helvetica', 'Arial', 'sans-serif';
            overflow: scroll;
            border: 1px;
            border-style: solid;
        }

        #comment-box h3 {
            font-family: 'Patua One', cursive;
            justify-content: right;
        }

        #backToTop {
            position: fixed;
            bottom: 1rem;
            right: 2rem;
            width: 4rem;
            visibility: hidden;
        }
    </style>

</head>

<body>
    <h1 style="font-family: 'Julius Sans One', sans-serif;">Comments, Questions, Concerns?</h1>
    <div id="toolbar"></div>
    <div id="editor"></div>

    <button style="height: 40px;" id="saveButton">Click to Save Post</button>
    <div style="height:20px"></div>

    <div id="pseudo-editor"></div>

    <img id="backToTop" src="https://png.icons8.com/nolan/50/000000/circled-up-2.png">

    <script>

        $(document).ready(function () {

            let toolbarOptions = [
                ['bold', 'italic', 'underline', 'strike'],
                ['blockquote', 'code-block'],
                [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                [{ 'script': 'sub' }, { 'script': 'super' }],
                [{ 'indent': '-1' }, { 'indent': '+1' }],
                [{ 'size': ['small', false, 'large', 'huge'] }],
                ['link', 'image', 'video', 'formula'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'font': [] }],
                [{ 'align': [] }]
            ];

            let quill = new Quill('#editor', {
                modules: {
                    toolbar: toolbarOptions
                },
                placeholder: 'Type your (optionally derisive) thoughts here, until I turn this into a route for my personal blog post portal',
                theme: 'snow'
            });


            // Want this to happen by default on page load before user sees
            // Get + display persistent old comments from posts database
            $.get("/dbComments", function (data) {
                console.log(data, " is the data");
                for (let i = 0; i < data.length; i++) {
                    let date = new Date(data[i].entry_time.split("T")[0].replace(/-/g, "/") + " " + data[i].entry_time.split("T")[1].substring(0, 7) + " UTC");
                    date = date.toString().split(" GMT")[0];

                    $("#pseudo-editor").append(
                        "<div id =\"comment-box\">" +
                        "<h3>" +
                        "Posted on " + date + " by a lonely soul" +
                        "</h3>" +
                        "<div id=\"comment-content\"" +
                        data[i].content +
                        "</div>" +
                        "</div>"
                    );
                }
            });

            $('#saveButton').click(function () {
                $("html, body").animate({ scrollTop: $(document).height() }, 1500);
                $("#backToTop").animate({ opacity: 1 }, 'slow', function () {
                    $("#backToTop").css("visibility", "visible");
                });

                // Visually show the new comment getting appended to existing comments for user
                // let newComment = quill.getContents();
                // let oldComments = quill2.getContents();
                // let combinedComments = oldComments.concat(newComment);
                // quill2.setContents(combinedComments);

                // Grab text that user is trying to submit, make it a JSON format
                let text = quill.container.firstChild.innerHTML;
                let reqBody = {
                    "content": text,
                };

                // Post JSON formatted new comment to posts database
                $.ajax({
                    type: "post",
                    data: JSON.stringify(reqBody),
                    url: '/submit',
                    dataType: 'json',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    success: function (data) {
                        console.log("The data posted is: ", data);
                    },
                    error: function (e) {
                        console.log("POST REQ ERROR : ", e);
                    }
                });

                $.get("/dbComments", function (data) {
                    $("#pseudo-editor").append(
                        "<div id =\"comment-box\">" +
                        "<h3>" +
                        "Posted on " + data[data.length - 1].entry_time.split("T")[0].replace(/-/g, "/") + " by dumb Anon" +
                        "</h3>" +
                        "<div id=\"comment-content\"" +
                        data[data.length - 1].content +
                        "</div>" +
                        "</div>"
                    );
                })
            });

            $("#backToTop").click(function () {
                $("html, body").animate({ scrollTop: 0 }, 1500);
                $("#backToTop").animate({ opacity: 0 }, 'fast', function () {
                    $("#backToTop").css("visibility", "hidden");
                });
            });
        });
    </script>


</body>

</html>